name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Verify build output
      run: |
        echo "📁 Checking dist/ folder contents:"
        ls -la dist/
        echo ""
        echo "🔍 Looking for .htaccess:"
        if [ -f dist/.htaccess ]; then
          echo "✅ .htaccess found!"
          cat dist/.htaccess
        else
          echo "❌ .htaccess NOT found!"
        fi

    - name: Create deployment package
      run: |
        mkdir -p deployment-package
        
        # Copy frontend build
        cp -r dist/* deployment-package/
        
        # Explicitly copy hidden files (.htaccess)
        if [ -f dist/.htaccess ]; then
          cp dist/.htaccess deployment-package/.htaccess
          echo "✓ Copied .htaccess"
        else
          echo "⚠ WARNING: .htaccess not found in dist/"
        fi
        
        if [ -f dist/.htaccess.minimal ]; then
          cp dist/.htaccess.minimal deployment-package/.htaccess.minimal
          echo "✓ Copied .htaccess.minimal"
        else
          echo "⚠ WARNING: .htaccess.minimal not found in dist/"
        fi
        
        # Copy API files (excluding config.php - must be maintained on server!)
        mkdir -p deployment-package/api
        cp -r api/* deployment-package/api/
        rm -f deployment-package/api/config.php  # Never deploy config.php!
        
        # Copy database migrations
        mkdir -p deployment-package/database
        cp -r database/* deployment-package/database/
        
        # Create deployment instructions
        cat > deployment-package/DEPLOY_INSTRUCTIONS.txt << 'EOF'
        ═══════════════════════════════════════════════════════════════
        🚀 DEPLOYMENT INSTRUCTIONS
        ═══════════════════════════════════════════════════════════════
        
        STEP 1: Upload Frontend Files
        -------------------------------
        Upload everything from the root to: /home/elektry/www/
        
        Files to upload:
        - .htaccess (IMPORTANT! For HTTPS redirect & PWA)
        - .htaccess.minimal (backup version)
        - index.html
        - manifest.json (for PWA)
        - service-worker.js (for PWA)
        - offline.html (for PWA)
        - assets/ (entire folder)
        - elektr-ame-media/ (entire folder)
        - pwa-icons/ (entire folder - for PWA)
        - favicon.ico
        - placeholder.svg
        - robots.txt
        
        STEP 2: Upload Backend Files  
        -------------------------------
        Upload api/ folder contents to: /home/elektry/www/api/
        
        ⚠️ IMPORTANT: Do NOT upload api/config.php!
        Your existing config.php on the server has the correct database
        credentials and must NOT be overwritten.
        
        STEP 3: Run Database Migrations (if needed)
        ---------------------------------------------
        Check database/ folder for any new .sql files
        Run them in phpMyAdmin if you haven't already
        
        STEP 4: Test
        --------------
        ✅ HTTPS working (padlock in address bar)
        ✅ Admin panel works
        ✅ Email automation shows templates
        ✅ Members can set passwords
        ✅ Members can log in
        ✅ Member portal loads
        ✅ PWA install prompt appears (wait 5 seconds)
        ✅ DevTools → Application → Service Worker registered
        ✅ DevTools → Application → Manifest loads correctly
        
        ═══════════════════════════════════════════════════════════════
        ✅ DEPLOYMENT COMPLETE!
        ═══════════════════════════════════════════════════════════════
        EOF

    - name: Create deployment zip
      run: |
        cd deployment-package
        # Create zip that includes hidden files
        zip -r ../elektr-ame-deployment.zip . -x "*.git*"
        cd ..
        echo "📦 Deployment zip created"
        echo ""
        echo "🔍 Verifying zip contents:"
        unzip -l elektr-ame-deployment.zip | head -30
        echo ""
        echo "🔍 Looking for .htaccess in zip:"
        if unzip -l elektr-ame-deployment.zip | grep -q "\.htaccess$"; then
          echo "✅ .htaccess IS in the zip file!"
        else
          echo "❌ .htaccess NOT in the zip file!"
        fi
        
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v3
      with:
        name: deployment
        path: elektr-ame-deployment.zip
        retention-days: 30

    - name: Show artifact info
      run: |
        echo "✅ Deployment package created successfully!"
        echo ""
        echo "📦 Zip file size:"
        ls -lh elektr-ame-deployment.zip
        echo ""
        echo "📥 DOWNLOAD INSTRUCTIONS:"
        echo "1. Go to: https://github.com/${{ github.repository }}/actions"
        echo "2. Click on this workflow run"
        echo "3. Download: 'deployment' artifact"
        echo "4. Extract: elektr-ame-deployment.zip"
        echo "5. Upload all contents to OVH (including .htaccess)"
        echo ""
        echo "🔍 The zip includes:"
        echo "   ✓ .htaccess (HTTPS redirect)"
        echo "   ✓ .htaccess.minimal (backup)"
        echo "   ✓ All frontend files"
        echo "   ✓ All API files"
        echo "   ✓ Database migrations"

